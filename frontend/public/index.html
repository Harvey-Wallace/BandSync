<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no, maximum-scale=1" />
    <meta name="theme-color" content="#0d6efd" />
    <meta name="description" content="BandSync - Band event and attendance manager" />
    
    <!-- iOS-specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="BandSync">
    
    <!-- iOS icon -->
    <link rel="apple-touch-icon" href="favicon.ico">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="%PUBLIC_URL%/env-config.js" as="script">
    
    <link rel="manifest" href="manifest.json" />
    <title>BandSync</title>
  </head>
  <body>
    <noscript>
      <div style="padding: 20px; font-family: Arial, sans-serif; text-align: center;">
        <h1>JavaScript Required</h1>
        <p>You need to enable JavaScript to run this app.</p>
        <p>Please enable JavaScript in your browser settings and reload the page.</p>
      </div>
    </noscript>
    
    <!-- iOS Debug Overlay (loads before React) -->
    <div id="ios-debug-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); color: white; padding: 10px; font-family: monospace; font-size: 11px; z-index: 99999; overflow: auto;">
      <div style="margin-bottom: 10px;">
        <strong>üêõ iOS Debug Info</strong>
        <button onclick="location.reload()" style="float: right; background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 3px;">Reload</button>
      </div>
      <div id="debug-content"></div>
    </div>
    
    <!-- Load environment config before React -->
    <script src="%PUBLIC_URL%/env-config.js"></script>
    
    <!-- Pre-React iOS debugging -->
    <script>
      // Early iOS detection and debugging
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const errors = [];
      const logs = [];
      
      // Capture all errors and logs
      window.addEventListener('error', function(event) {
        const error = {
          message: event.message,
          filename: event.filename,
          lineno: event.lineno,
          colno: event.colno,
          stack: event.error ? event.error.stack : null,
          timestamp: new Date().toISOString()
        };
        errors.push(error);
        console.error('Global error:', error);
        if (isIOS) updateDebugOverlay();
      });
      
      window.addEventListener('unhandledrejection', function(event) {
        const error = {
          type: 'Promise Rejection',
          reason: event.reason.toString(),
          timestamp: new Date().toISOString()
        };
        errors.push(error);
        console.error('Unhandled promise rejection:', error);
        if (isIOS) updateDebugOverlay();
      });
      
      // Override console methods to capture output
      const originalLog = console.log;
      const originalError = console.error;
      const originalWarn = console.warn;
      
      console.log = function(...args) {
        logs.push({ type: 'log', message: args.join(' '), timestamp: new Date().toISOString() });
        originalLog.apply(console, args);
        if (isIOS) updateDebugOverlay();
      };
      
      console.error = function(...args) {
        logs.push({ type: 'error', message: args.join(' '), timestamp: new Date().toISOString() });
        originalError.apply(console, args);
        if (isIOS) updateDebugOverlay();
      };
      
      console.warn = function(...args) {
        logs.push({ type: 'warn', message: args.join(' '), timestamp: new Date().toISOString() });
        originalWarn.apply(console, args);
        if (isIOS) updateDebugOverlay();
      };
      
      function updateDebugOverlay() {
        if (!isIOS) return;
        
        const overlay = document.getElementById('ios-debug-overlay');
        const content = document.getElementById('debug-content');
        
        if (overlay && content) {
          overlay.style.display = 'block';
          
          let html = `
            <div style="margin-bottom: 10px;">
              <strong>Device Info:</strong><br>
              User Agent: ${navigator.userAgent}<br>
              Viewport: ${window.innerWidth}x${window.innerHeight}<br>
              iOS: ${isIOS}<br>
              Standalone: ${window.navigator.standalone}<br>
            </div>
            
            <div style="margin-bottom: 10px;">
              <strong>Environment:</strong><br>
              NODE_ENV: ${window.process?.env?.NODE_ENV || 'undefined'}<br>
              REACT_APP_API_URL: ${window.process?.env?.REACT_APP_API_URL || window.ENV?.REACT_APP_API_URL || 'undefined'}<br>
              Window ENV: ${JSON.stringify(window.ENV || {})}<br>
            </div>
          `;
          
          if (errors.length > 0) {
            html += `
              <div style="margin-bottom: 10px;">
                <strong>‚ùå Errors (${errors.length}):</strong><br>
                ${errors.slice(-5).map(error => `
                  <div style="background: #800; padding: 5px; margin: 2px 0; border-radius: 3px;">
                    ${error.message || error.reason}<br>
                    ${error.filename ? `<small>File: ${error.filename}:${error.lineno}</small><br>` : ''}
                    ${error.stack ? `<small>Stack: ${error.stack.substring(0, 200)}...</small>` : ''}
                  </div>
                `).join('')}
              </div>
            `;
          }
          
          if (logs.length > 0) {
            html += `
              <div style="margin-bottom: 10px;">
                <strong>üìù Console (last 10):</strong><br>
                <div style="background: #111; padding: 5px; max-height: 200px; overflow: auto;">
                  ${logs.slice(-10).map(log => `
                    <div style="color: ${log.type === 'error' ? '#ff6b6b' : log.type === 'warn' ? '#ffd93d' : '#6bcf7f'}; font-size: 10px; margin-bottom: 2px;">
                      [${log.timestamp.split('T')[1].split('.')[0]}] ${log.type.toUpperCase()}: ${log.message}
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }
          
          html += `
            <div style="margin-bottom: 10px;">
              <strong>üß™ Tests:</strong><br>
              <button onclick="testLocalStorage()" style="margin: 2px; padding: 5px; font-size: 10px;">Test localStorage</button>
              <button onclick="testAPI()" style="margin: 2px; padding: 5px; font-size: 10px;">Test API</button>
              <button onclick="testReactLoad()" style="margin: 2px; padding: 5px; font-size: 10px;">Test React Load</button>
              <button onclick="clearData()" style="margin: 2px; padding: 5px; font-size: 10px; background: #dc3545; color: white;">Clear Data</button>
            </div>
          `;
          
          content.innerHTML = html;
        }
      }
      
      function testLocalStorage() {
        try {
          localStorage.setItem('test', 'value');
          localStorage.removeItem('test');
          alert('‚úÖ localStorage works');
        } catch (e) {
          alert('‚ùå localStorage failed: ' + e.message);
        }
      }
      
      function testAPI() {
        const apiUrl = window.ENV?.REACT_APP_API_URL || 'https://app.bandsync.co.uk/api';
        fetch(apiUrl + '/health')
          .then(r => r.ok ? alert('‚úÖ API reachable') : alert('‚ùå API returned ' + r.status))
          .catch(e => alert('‚ùå API failed: ' + e.message));
      }
      
      function testReactLoad() {
        const reactRoot = document.getElementById('root');
        if (reactRoot && reactRoot.innerHTML.trim()) {
          alert('‚úÖ React content found');
        } else {
          alert('‚ùå React not loaded or empty');
        }
      }
      
      function clearData() {
        localStorage.clear();
        sessionStorage.clear();
        location.reload();
      }
      
      // Show debug overlay if iOS
      if (isIOS) {
        console.log('iOS detected, initializing debug overlay...');
        setTimeout(updateDebugOverlay, 100);
        
        // Also show overlay if React doesn't load within 5 seconds
        setTimeout(() => {
          const reactRoot = document.getElementById('root');
          if (!reactRoot || !reactRoot.innerHTML.trim()) {
            console.log('React failed to load, showing debug overlay...');
            updateDebugOverlay();
          }
        }, 5000);
      }
    </script>
    
    <div id="root"></div>
  </body>
</html>
